name: EPUB Generation and Release (Simplified Paths)

# 1. Trigger the workflow manually or on a daily schedule
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  build_and_release:
    # 2. Run on a Windows runner
    runs-on: windows-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # Step to get the current date for the release name/tag
      - name: Set Release Date
        id: set_date
        shell: pwsh
        run: |
          $date = Get-Date -Format "yyyy-MM-dd"
          Write-Output "build_date=$date" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      # 3. Run EPUB Builders
      - name: Run EPUB Builders
        env:
          # This ensures Python uses UTF-8 for I/O operations across all files
          PYTHONIOENCODING: utf-8
        shell: pwsh
        run: |
          python .\scripts\epub_builders\orv.py
          python .\scripts\epub_builders\cont.py
          python .\scripts\epub_builders\side.py

      # 4. Create EPUB Archives (Zipping) - UPDATED FILENAMES
      - name: Create EPUB Archives (Zipping)
        shell: pwsh
        run: |
          # Ensure the output directory for final artifacts exists
          mkdir -Force .\artifacts
          
          # Use simple, alphanumeric filenames to avoid path issues
          Compress-Archive -Path .\epub\orv\* -DestinationPath .\artifacts\orv_main.epub -Force
          Compress-Archive -Path .\epub\cont\* -DestinationPath .\artifacts\orv_sequel.epub -Force
          Compress-Archive -Path .\epub\side\* -DestinationPath .\artifacts\orv_side.epub -Force

      # 5. Upload Main Story EPUB as a separate artifact - UPDATED PATH
      - name: Upload Main Story EPUB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: orv-main-story-build-${{ steps.set_date.outputs.build_date }}
          path: .\artifacts\orv_main.epub
          retention-days: 2

      # 5. Upload Sequel EPUB as a separate artifact - UPDATED PATH
      - name: Upload Sequel EPUB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: orv-sequel-build-${{ steps.set_date.outputs.build_date }}
          path: .\artifacts\orv_sequel.epub
          retention-days: 2

      # 5. Upload Side Stories EPUB as a separate artifact - UPDATED PATH
      - name: Upload Side Stories EPUB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: orv-side-stories-build-${{ steps.set_date.outputs.build_date }}
          path: .\artifacts\orv_side.epub
          retention-days: 2

      # 6. Create a GitHub Release and attach all three EPUB files
      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: EPUB-BUILD-${{ steps.set_date.outputs.build_date }}-${{ github.run_number }}
          name: EPUB Release ${{ steps.set_date.outputs.build_date }}
          body: |
            Automated EPUB build of Omniscient Reader's Viewpoint, generated on ${{ steps.set_date.outputs.build_date }}.
            
            **Included Files:**
            - orv_main.epub (Main Story)
            - orv_sequel.epub (Sequel)
            - orv_side.epub (Side Stories)
          # This wildcard correctly attaches the three new files (orv_main.epub, etc.)
          files: .\artifacts\*.epub 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
